<html>
<head>
    <title>JS Sandbox</title>
<script src="js.js/libjs.O2.js"></script>
<script src="js.js/jsjs-wrapper.js"></script>
<script src="lib/jquery.1.7.2.min.js"></script>
<style type="text/css">
        #editor { 
            height: 60%;
        }
        #buttons {
            height: 1.6em;
        }
        #console {
            height: 25%;
        }
        #console_log {
            font-family: monospace;
            white-space: pre;
            overflow: auto;
            height: 100%;
        }
        h3 {font-size: .8em;}
</style>
    
<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
function reportMessage(s) {
    var args = Array.prototype.slice.call(arguments, 0);
    s = args.join(" ");
    console.log(s);
    console_log = $('#console_log');
    console_log.append(s + "<br/>");
    console_log.scrollTop(console_log[0].scrollHeight);
}

function assert(v) {
    if (!v) {
        throw "Assertion failed";
    }
}

    JSJS.Types['JSVal'] = new function() {
            this['toJSVal'] = function(jsval, val, cx) {
                // jsval = val;
                // var jsvalout = allocate(8, 'i32', ALLOC_NORMAL);
                _memcpy(jsval, val, 8);
                return;
            };
            this['type'] = 'JSVal';
    };

    JSJS.SetCallHook = function(rt, callHookFunc, closure) {
        var funcPosition = FUNCTION_TABLE.push(callHookFunc) - 1;
        return _JS_SetCallHook(rt, funcPosition, closure);
    };

    
    /* Eval function in js.js's name-mangled SpiderMonkey.
    Demangled: _EvalKernel(JSContext*, js::CallArgs const&, EvalType, js::StackFrame*, JSObject&) */
    originalEval = __ZL10EvalKernelP9JSContextRKN2js8CallArgsE8EvalTypePNS1_10StackFrameER8JSObject;
    __ZL10EvalKernelP9JSContextRKN2js8CallArgsE8EvalTypePNS1_10StackFrameER8JSObject = function ($cx, $call, $evalType, $caller, $scopeobj) {
        // reportMessage('eval', $cx, $call, $evalType, $caller, $scopeobj);

        var callerFunc;

        var fn = _JS_GetFrameFunction($cx, $caller);
        if (fn) {        
            // Try to get the name of non-anonymous functions
            var name = _JS_GetFunctionId(fn);
            if (name) {
                var idStr = _JSID_TO_STRING(name);
                idStr = _JS_GetStringCharsZ($cx, idStr); 
                var idStrReal = JSJS.parseUTF16(idStr);
                callerFunc = idStrReal;
            }
        }

        var result = originalEval($cx, $call, $evalType, $caller, $scopeobj);

        // Get the argument to eval
        var argv = __ZNK2js8CallArgs4argvEv($call);
        var parameter = JSJS.identifyConvertValue($cx, argv);

        // TODO: Get and report the return value
        // TODO: Report the line number if possible

        reportMessage('eval(' + parameter + '), called by', callerFunc);

        return result;
    }; 


    var editor;

    function init_editor() {
        editor = ace.edit("editor");
        editor.getSession().setUseWorker(false);
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/javascript");

        $('#run').click(start_jsjs);
    }

    function start_jsjs(e) {
        var src = editor.getValue();
        var jsObjs = JSJS.Init();

        function callHookFunc(cx, fp, before, ok, closure) {
            console.log('Function called', before, ok, closure);
            var fn = _JS_GetFrameFunction(cx, fp);
            if (!fn) {
                return closure;
            }

            // Try to get the name of non-anonymous functions
            var name = _JS_GetFunctionId(fn);
            if (name) {
                var idStr = _JSID_TO_STRING(name);
                idStr = _JS_GetStringCharsZ(cx, idStr); 
                var idStrReal = JSJS.parseUTF16(idStr);
                console.log("Func name", idStrReal);
            }

            // console.log("Call Hook!", getValue(fp + 4, 'i32'));
            return closure;
        }

        _JS_SetDebugMode(jsObjs.cx, true);

        // var res = JSJS.SetCallHook(jsObjs.rt, callHookFunc, this);
        // console.log('Call hook', res ? 'set' : 'not set');

        function errorReporter(cx, message, report) {
            reportMessage("js.js Script Error (line: " + getValue(report + 4, 'i32') + "): " + Pointer_stringify(message));
        }
        JSJS.SetErrorReporter(jsObjs.cx, errorReporter);

    
        function eval_func(s) {
            // Get the local context
            var thisObj = _JS_GetGlobalForScopeChain(jsObjs.cx);
            reportMessage("this:", thisObj);

            // Do the actual eval
            var rval = JSJS.EvaluateScript(jsObjs.cx, thisObj, s);

            // Convert return value to string to pretty-print it
            // (this can call the value's toString() function in javascript).
            var rvalAsString = _JS_ValueToString(jsObjs.cx, rval);
            // Convert JSVal to a javascript string
            var resultStr = JSJS.identifyConvertValue(jsObjs.cx, rvalAsString);
            reportMessage("<strong>eval</strong>(" + s + ") = " + resultStr);
            

            return rval; // return JSVal directly

            // var d;
            // if (rval) {
            //     //Convert the JSVal to a double
            //     d = JSJS.identifyConvertValue(jsObjs.cx, rval);
            //     return d;
            // } else { return; }
        }
        
        var wrappedNativeFuncEval = JSJS.wrapFunction({
            func: eval_func,
            args: [JSJS.Types['charPtr']],
            returns: JSJS.Types['JSVal']});
        // JSJS.DefineFunction(jsObjs.cx, jsObjs.glob, "eval", wrappedNativeFuncEval, 1, 0);
        
        function alert_func(s) {
            reportMessage("<strong>alert</strong>: " + s);
            alert(s);
        }
        var wrappedNativeFuncAlert = JSJS.wrapFunction({
            func: alert_func,
            args: [JSJS.Types['charPtr']]});
        JSJS.DefineFunction(jsObjs.cx, jsObjs.glob, "alert", wrappedNativeFuncAlert, 1, 0);
        
        // reportMessage("Running script");

        var rval = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob, src);
        
        var d;
        if (rval) {
            //Convert the JSVal to a double
            d = JSJS.identifyConvertValue(jsObjs.cx, rval);
            d = "Result = " + d;
        } else {
            d = "Can't get result because an error happened.";
        }
    
        reportMessage(d);
        
        // This is how you do a proper shut down
        JSJS.End(jsObjs);
    }
    
    $(document).ready(init_editor);

</script>
  <body>
    <div class="container">
        <div id="buttons">
            <button id="run">Run</button>
        </div>
        <div id="editor">function test(x, y) { return eval("x + y"); }

alert(test(1, 1));
</div>
        <div id="console">
            <h3>Console</h3>
            <div id="console_log"></div>
        </div>
    </div>
  </body>
</html>