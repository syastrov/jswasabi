<!DOCTYPE html>
<html lang="en">
<head>
    <title>JSWasabi</title>
<script src="js.js/libjs.O2.js"></script>
<script src="js.js/jsjs-wrapper.js"></script>
<script src="lib/jquery.1.7.2.min.js"></script>

<script src="jswasabi.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/bootstrap.min.css">

<style type="text/css">
        #editor { 
            position: relative;
            height: 500px;
        }
        
        #console_log {
            overflow: auto;
        }

        body {
            background-color: #849137;
        }

        .btn-default {
            background-color: #4a511f;
            color: #fff;
        } 

        .btn-default:hover {
            background-color: #5b6426;
            color: #fff;
        } 

        .panel-body {
            background-color: #ccc;
        }
</style>
    
<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
function reportMessage(s) {
    var args = Array.prototype.slice.call(arguments, 0);
    s = args.join(" ");
    console.log(s);
    console_log = $('#console_log');
    console_log.append(s + "<br/>");
    console_log.scrollTop(console_log[0].scrollHeight);
}

function clearConsole() {
    $('#console_log').html('');
}

function assert(v) {
    if (!v) {
        throw "Assertion failed";
    }
}


    var editor;

    function init_editor() {
        editor = ace.edit("editor");
        ace.config.set("workerPath", "ace");
        editor.getSession().setUseWorker(false);
        editor.setTheme("ace/theme/monokai");
        document.getElementById('editor').style.fontSize='14px';
        editor.getSession().setMode("ace/mode/javascript");

        $('#run').click(start_jsjs);
    }

    function start_jsjs(e) {
        clearConsole();

        var src = editor.getValue();

        var jsObjs = JSJS.Init();

        JSWasabi.SetEvalCallback(function (evalArgs, callerFunc) {
          if (!callerFunc) {
            callerFunc = '[global]';
          }

          reportMessage("<strong>eval</strong>(" + evalArgs + "), from <strong>" + callerFunc + "</strong>");
        });

        JSWasabi.SetCallHook(jsObjs.cx, jsObjs.rt, function (funcName) {
          reportMessage("<strong>" + funcName + "</strong> called");
        });


        function errorReporter(cx, message, report) {
            var lineNo = getValue(report + 4, 'i32') + 1;
            reportMessage("<a href='javascript: editor.gotoLine(" + lineNo + ", 0, true);'>"
                + "js.js Script Error (line: " + lineNo + "): " + Pointer_stringify(message) + '</a>');
        }
        JSJS.SetErrorReporter(jsObjs.cx, errorReporter);

    
        /*
        // Override built-in alert function
        function alert_func(s) {
            reportMessage("<strong>alert</strong>: " + s);
            alert(s);
        }
        var wrappedNativeFuncAlert = JSJS.wrapFunction({
            func: alert_func,
            args: [JSJS.Types['charPtr']]});
        JSJS.DefineFunction(jsObjs.cx, jsObjs.glob, "alert", wrappedNativeFuncAlert, 1, 0);
        */

        var rval = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob, src);

        // Evaluate code for getting all globals
        var getGlobalsSrc = "var _$$$_globals = {}; for (v in this) { if (v != '_$$$_globals' && this.hasOwnProperty(v)) { _$$$_globals[v] = this[v]; } } JSON.stringify(_$$$_globals);";
        var globals = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob, getGlobalsSrc);
                

        var d;
        if (rval) {
            // Convert the JSVal to a native javascript type
            d = JSJS.identifyConvertValue(jsObjs.cx, rval);
            d = "Result = " + d;
        } else {
            d = "Can't get result because an error happened.";
        }
    
        reportMessage(d);

        reportMessage("Globals:", JSJS.identifyConvertValue(jsObjs.cx, globals));
        
        // This is how you do a proper shut down
        JSJS.End(jsObjs);
    }
    
    $(document).ready(init_editor);

</script>
  <body>
    <div class="container">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h1 class="panel-title">JSWasabi Editor</h1>
            </div>
            <div class="panel-heading">
               <button id="run" class="btn btn-default btn-lg">Run</button>
            </div>
            <div class="panel-body">
                <div id="editor">var global = 1; var global2 = 'a';
function test(x, y) { global = 2; return eval("eval('x + y')"); }

test(1, 1);</div>
            </div>
            <div id="console" class="panel-footer">
                <h3 class="panel-title">Console</h3>
                <pre id="console_log"></pre>
           </div>
        </div>
        <div class="text-center well"><a href="https://github.com/syastrov/jswasabi/">JSWasabi</a>. A project by <a href="https://github.com/syastrov/">Seth Yastrov</a>. Using Jeff Terrace's <a href="https://github.com/jterrace/js.js/">js.js</a>.</p>
    </div>
  </body>
</html>