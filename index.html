<html>
<head>
    <title>JS Sandbox</title>
<script src="js.js/libjs.O2.js"></script>
<script src="js.js/jsjs-wrapper.js"></script>
<script src="lib/jquery.1.7.2.min.js"></script>

<script src="jswasabi.js"></script>

<style type="text/css">
        #editor { 
            height: 60%;
        }
        #buttons {
            height: 1.6em;
        }
        
        #console {
            height: 25%;
        }
        #console_log {
            font-family: monospace;
            white-space: pre;
            overflow: auto;
            height: 100%;
        }
        h3 {font-size: .8em;}
</style>
    
<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
function reportMessage(s) {
    var args = Array.prototype.slice.call(arguments, 0);
    s = args.join(" ");
    console.log(s);
    console_log = $('#console_log');
    console_log.append(s + "<br/>");
    console_log.scrollTop(console_log[0].scrollHeight);
}

function clearConsole() {
    $('#console_log').html('');
}

function assert(v) {
    if (!v) {
        throw "Assertion failed";
    }
}


    var editor;

    function init_editor() {
        editor = ace.edit("editor");
        editor.getSession().setUseWorker(false);
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/javascript");

        $('#run').click(start_jsjs);
    }

    function start_jsjs(e) {
        clearConsole();

        var src = editor.getValue();

        var jsObjs = JSJS.Init();

        JSWasabi.SetEvalCallback(function (evalArgs, callerFunc) {
          if (!callerFunc) {
            callerFunc = '[global]';
          }

          reportMessage("<strong>eval</strong>(" + evalArgs + "), from <strong>" + callerFunc + "</strong>");
        });

        JSWasabi.SetCallHook(jsObjs.cx, jsObjs.rt, function (funcName) {
          reportMessage("<strong>" + funcName + "</strong> called");
        });


        function errorReporter(cx, message, report) {
            var lineNo = getValue(report + 4, 'i32') + 1;
            reportMessage("<a href='javascript: editor.gotoLine(" + lineNo + ", 0, true);'>"
                + "js.js Script Error (line: " + lineNo + "): " + Pointer_stringify(message) + '</a>');
        }
        JSJS.SetErrorReporter(jsObjs.cx, errorReporter);

    
        /*
        // Override built-in alert function
        function alert_func(s) {
            reportMessage("<strong>alert</strong>: " + s);
            alert(s);
        }
        var wrappedNativeFuncAlert = JSJS.wrapFunction({
            func: alert_func,
            args: [JSJS.Types['charPtr']]});
        JSJS.DefineFunction(jsObjs.cx, jsObjs.glob, "alert", wrappedNativeFuncAlert, 1, 0);
        */

        var rval = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob, src);

        // Evaluate code for getting all globals
        var getGlobalsSrc = "var _$$$_globals = {}; for (v in this) { if (v != '_$$$_globals') { _$$$_globals[v] = this[v]; } } JSON.stringify(_$$$_globals);";
        var globals = JSJS.EvaluateScript(jsObjs.cx, jsObjs.glob, getGlobalsSrc);
                

        var d;
        if (rval) {
            // Convert the JSVal to a native javascript type
            d = JSJS.identifyConvertValue(jsObjs.cx, rval);
            d = "Result = " + d;
        } else {
            d = "Can't get result because an error happened.";
        }
    
        reportMessage(d);

        reportMessage("Globals:", JSJS.identifyConvertValue(jsObjs.cx, globals));
        
        // This is how you do a proper shut down
        JSJS.End(jsObjs);
    }
    
    $(document).ready(init_editor);

</script>
  <body>
    <div class="container">
        <div id="buttons">
            <button id="run">Run</button>
        </div>
        <div id="editor">var global = 1; var global2 = 'a';
function test(x, y) { global = 2; return eval("eval('x + y')"); }

test(1, 1);
</div>
        <div id="console">
            <h3>Console</h3>
            <div id="console_log"></div>
        </div>
    </div>
  </body>
</html>